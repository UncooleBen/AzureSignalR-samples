# Build SignalR-based Android Chatting App

This tutorial shows you how to build and modify a BSignalR-based Android Chatting App. You'll learn how to:

> **&#x2713;** Build a mobile chat room client with SignalR client and Android Studio.
>
> **&#x2713;** Build a chat room server with Azure SignalR Service and Visual Studio.
>
> **&#x2713;** Chat with the mobile app.

## Prerequisites
* Install [.NET Core 3.0 SDK](https://dotnet.microsoft.com/download/dotnet-core/3.0) (Version >= 3.0.100)
* Install [Visual Studio 2019](https://visualstudio.microsoft.com/vs/) (Version >= 16.3)
* Install [Android Studio](https://developer.android.com/studio) (We use ver. 4.0.1)


## Build a mobile chat room client with SignalR client and Android Studio

1. Create a new project in Android Studio
   
   Launch Android Studio, choose Start a new Android Studio project -> Phone and Tablet -> Basic Activity -> Next -> Name your project -> Name your package as `com.microsoft.signalr.androidchatroom` -> Select Java as language -> Choose API 16 as Minimum SDK -> Finish.

2. Copy directory `AndroidChatRoomClient/app/src/main/res` into your own application.
    
    This step creates various layouts that we will use in the later parts.

3. Add dependencies in `build.gradle`

    1. In project scope `build.gradle`, add `classpath 'com.google.gms:google-services:4.3.4'` under `dependencies`

    2. In module scope `build.gradle`, replace `dependencies` with :
    ```gradle
    dependencies {
        implementation fileTree(dir: 'libs', include: ['*.jar'])
        implementation 'androidx.appcompat:appcompat:1.2.0'
        implementation 'com.google.android.material:material:1.2.1'
        implementation 'androidx.constraintlayout:constraintlayout:2.0.2'
        implementation 'androidx.navigation:navigation-fragment:2.3.0'
        implementation 'androidx.navigation:navigation-ui:2.3.0'
        implementation 'androidx.navigation:navigation-dynamic-features-fragment:2.3.0'
        implementation 'com.microsoft.signalr:signalr:3.0.0'
        implementation 'com.google.firebase:firebase-analytics:17.6.0'
        implementation 'com.google.firebase:firebase-messaging:20.3.0'
        testImplementation 'junit:junit:4.13'
        androidTestImplementation 'androidx.test.ext:junit:1.1.2'
        androidTestImplementation 'androidx.test.espresso:espresso-core:3.3.0'
    }
    ```

    and add `apply plugin: 'com.google.gms.google-services'` in the root level (just below `apply plugin: 'com.android.application'`)
   
4. Edit `MainActivity.java` as follow code segment.
    
    Two things will be done in this step: 
    1. Create a `NotificationChannel` for pushing notification when the app is in background.
    2. Remove the redundant components generated by the Android Studio.

    ```java
    package com.microsoft.signalr.androidchatroom;

    import android.app.NotificationChannel;
    import android.app.NotificationManager;
    import android.content.Intent;
    import android.os.Build;
    import android.os.Bundle;
    import android.util.Log;

    import androidx.appcompat.app.AppCompatActivity;
    import androidx.appcompat.widget.Toolbar;

    public class MainActivity extends AppCompatActivity {

        private static final String CHANNEL_ID = "Message Notification Channel";

        @Override
        protected void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);
            createNotificationChannel();
            Intent intent = getIntent();
            Log.d("ActivityIntent", intent.toString());
            setContentView(R.layout.activity_main);
            Toolbar toolbar = findViewById(R.id.toolbar);
            setSupportActionBar(toolbar);
        }

        private void createNotificationChannel() {
            // Create the NotificationChannel, but only on API 26+ because
            // the NotificationChannel class is new and not in the support library
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                CharSequence name = getString(R.string.channel_name);
                String description = getString(R.string.channel_description);
                int importance = NotificationManager.IMPORTANCE_HIGH;
                NotificationChannel channel = new NotificationChannel(CHANNEL_ID, name, importance);
                channel.setDescription(description);
                // Register the channel with the system; you can't change the importance
                // or other notification behaviors after this
                NotificationManager notificationManager = getSystemService(NotificationManager.class);
                notificationManager.createNotificationChannel(channel);
            }
        }
    }
    ```
5. Create `Message` classes under package `com.microsoft.signalr.androidchatroom.message`.

    This step creates data structures for chat messages.
    1. Create `Message.java`, the base class for all messages, as follow:
    ```java
    package com.microsoft.signalr.androidchatroom.message;

    import java.util.UUID;

    public abstract class Message {
        public static final int SELF_SENDING_MESSAGE = 0x1;
        public static final int SELF_SENT_MESSAGE = 0x2;
        public static final int INCOMING_MESSAGE = 0x3;
        public static final int ENTER_MESSAGE = 0x4;
        public static final int LEAVE_MESSAGE = 0x5;

        private int messageEnum;
        private String content;
        private String uuid;

        public Message() {
            this.uuid = UUID.randomUUID().toString();
        }

        public int getMessageEnum() {
            return messageEnum;
        }

        public void setMessageEnum(int messageEnum) {
            this.messageEnum = messageEnum;
        }

        protected void setUuid(String uuid) {
            this.uuid = uuid;
        }

        public String getUuid() {
            return uuid;
        }

        public String getContent() {
            return content;
        }

        public void setContent(String content) {
            this.content = content;
        }
    }
    ```
    2. Create `ChatMessage.java`, storing chat message content, as follow:
    ```java
    package com.microsoft.signalr.androidchatroom.message;

    public class ChatMessage extends Message {

        private String sender;
        private String time;


        public ChatMessage(String sender, String time, String content, int messageEnum) {
            this.sender = sender;
            this.time = time;
            setContent(content);
            setMessageEnum(messageEnum);
        }

        public ChatMessage(String sender, String time, String content, String uuid, int messageEnum) {
            this.sender = sender;
            this.time = time;
            setContent(content);
            setUuid(uuid);
            setMessageEnum(messageEnum);
        }

        public String getSender() {
            return sender;
        }

        public void setSender(String sender) {
            this.sender = sender;
        }

        public String getTime() {
            return time;
        }

        public void setTime(String time) {
            this.time = time;
        }

    }
    ```
    3. Create `EnterLeaveMessage.java`, representing users' entering and leaving the chat room, as follow:
   ```java
   package com.microsoft.signalr.androidchatroom.message;

    public class EnterLeaveMessage extends Message {

        public EnterLeaveMessage(String username, int messageEnum) {
            setMessageEnum(messageEnum);
            switch (messageEnum) {
                case ENTER_MESSAGE:
                    setContent(String.format("%s has joined the chat", username));
                    break;
                case LEAVE_MESSAGE:
                default:
                    setContent(String.format("%s has left the chat", username));
            }
        }
    }
   ```

6. Create `Fragment` classes for navigation.

    This step will create two fragments:
    
    1. Create `LoginFragment.java`, containing login logics, as follow:
    ```java
    package com.microsoft.signalr.androidchatroom.fragment;

    import android.os.Bundle;
    import android.view.LayoutInflater;
    import android.view.View;
    import android.view.ViewGroup;
    import android.widget.Button;
    import android.widget.TextView;

    import androidx.annotation.NonNull;
    import androidx.fragment.app.Fragment;
    import androidx.navigation.fragment.NavHostFragment;

    import com.microsoft.signalr.androidchatroom.R;

    public class LoginFragment extends Fragment {
        private Button loginButton;
        private TextView usernameTextView;

        @Override
        public View onCreateView(
                LayoutInflater inflater, ViewGroup container,
                Bundle savedInstanceState
        ) {
            // Inflate the layout for this fragment
            View view = inflater.inflate(R.layout.fragment_login, container, false);

            // Get element references
            this.usernameTextView = view.findViewById(R.id.text_username_LoginFragment);
            this.loginButton = view.findViewById(R.id.button_login_LoginFragment);

            return view;
        }

        public void onViewCreated(@NonNull View view, Bundle savedInstanceState) {
            super.onViewCreated(view, savedInstanceState);

            if (loginButton != null && usernameTextView != null) {
                loginButton.setOnClickListener(
                    (v) -> {
                        if (usernameTextView.getText().toString().length() > 0) {
                            Bundle bundle = new Bundle();
                            bundle.putString("username", usernameTextView.getText().toString());
                            NavHostFragment.findNavController(LoginFragment.this)
                                    .navigate(R.id.action_LoginFragment_to_ChatFragment, bundle);
                        }
                    }
                );
            }
        }

    }
    ```
    2. Create `ChatFragment.java`, handling hub communication and chat message display, as follow:
    ```java
    package com.microsoft.signalr.androidchatroom.fragment;

    import android.content.Context;
    import android.os.Bundle;
    import android.util.Log;
    import android.view.LayoutInflater;
    import android.view.View;
    import android.view.ViewGroup;
    import android.widget.Button;
    import android.widget.EditText;
    import android.widget.TextView;

    import androidx.annotation.NonNull;
    import androidx.fragment.app.Fragment;
    import androidx.recyclerview.widget.LinearLayoutManager;
    import androidx.recyclerview.widget.RecyclerView;

    import com.google.firebase.iid.FirebaseInstanceId;
    import com.microsoft.signalr.HubConnection;
    import com.microsoft.signalr.HubConnectionBuilder;
    import com.microsoft.signalr.HubConnectionState;
    import com.microsoft.signalr.androidchatroom.R;
    import com.microsoft.signalr.androidchatroom.message.ChatMessage;
    import com.microsoft.signalr.androidchatroom.message.EnterLeaveMessage;
    import com.microsoft.signalr.androidchatroom.message.Message;

    import java.text.SimpleDateFormat;
    import java.util.ArrayList;
    import java.util.Date;
    import java.util.List;
    import java.util.Locale;
    import java.util.Timer;
    import java.util.TimerTask;
    import java.util.concurrent.atomic.AtomicInteger;

    import io.reactivex.disposables.Disposable;

    public class ChatFragment extends Fragment {
        // SignalR HubConnection
        private HubConnection hubConnection = null;

        // Messages
        private final List<Message> messages = new ArrayList<>();

        // Message count to send
        private AtomicInteger sendingMessageCount = new AtomicInteger(0);

        // User info
        private String username;
        private String deviceToken;

        // View elements and adapters
        private EditText chatBoxEditText;
        private Button chatBoxSendButton;
        private RecyclerView chatContentRecyclerView;
        private ChatContentAdapter chatContentAdapter;

        // Used for datetime formatting
        private SimpleDateFormat sdf = new SimpleDateFormat("MM/dd hh:mm:ss", Locale.UK);

        @Override
        public View onCreateView(
                LayoutInflater inflater, ViewGroup container,
                Bundle savedInstanceState
        ) {
            // Inflate the layout for this fragment
            View view = inflater.inflate(R.layout.fragment_chat, container, false);

            // Get passed parameters
            if (getArguments() != null) {
                this.username = getArguments().getString("username");
            } else {
                this.username = "Nobody";
            }

            // Get view element references
            this.chatBoxEditText = view.findViewById(R.id.edit_chat);
            this.chatBoxSendButton = view.findViewById(R.id.button_chatbox_send);
            this.chatContentRecyclerView = view.findViewById(R.id.recyclerview_chatcontent);

            // Create objects
            this.chatContentAdapter = new ChatContentAdapter(messages, getContext());
            LinearLayoutManager layoutManager = new LinearLayoutManager(this.getActivity());

            // Configure RecyclerView
            layoutManager.setStackFromEnd(true);
            chatContentRecyclerView.setLayoutManager(layoutManager);
            chatContentRecyclerView.setAdapter(chatContentAdapter);
            chatContentAdapter.notifyDataSetChanged();
            chatContentRecyclerView.scrollToPosition(messages.size() - 1);

            return view;
        }

        @Override
        public void onViewCreated(@NonNull View view, Bundle savedInstanceState) {
            super.onViewCreated(view, savedInstanceState);

            // Fetch device token for notification
            FirebaseInstanceId.getInstance()
                    .getInstanceId()
                    .addOnSuccessListener(
                            instanceIdResult -> this.deviceToken = instanceIdResult.getToken());

            // Create, register, and start hub connection
            this.hubConnection = HubConnectionBuilder.create(getString(R.string.app_server_url)).build();
            Disposable toDispose = hubConnection.start().subscribe(this::onHubConnectionStart);
        }

        public void onHubConnectionStart() {
            // Register the method handlers
            hubConnection.on("broadcastChatMessage", this::broadcastChatMessage,
                    String.class, String.class, String.class, String.class, String.class);
            hubConnection.on("broadcastEnterMessage", this::broadcastEnterMessage,
                    String.class);
            hubConnection.on("broadcastLeaveMessage", this::broadcastLeaveMessage,
                    String.class);

            // Broadcast user has entered chat room
            Log.d("EnterChatRoom", "called");
            hubConnection.send("EnterChatRoom", deviceToken, username);

            // Set onClickListener for SEND button
            chatBoxSendButton.setOnClickListener(this::chatBoxSendButtonClickListener);

            // Set periodic chat message sender method
            new Timer().scheduleAtFixedRate(new TimerTask() {
                @Override
                public void run() {
                    messageSendingHandler();
                }
            }, 500, 500);
        }

        public void chatBoxSendButtonClickListener(View view) {
            if (chatBoxEditText.getText().length() > 0) { // Empty message not allowed
                // Create and add message into list
                String messageContent = chatBoxEditText.getText().toString();
                ChatMessage chatMessage = new ChatMessage(username, sdf.format(new Date()), messageContent, Message.SELF_SENDING_MESSAGE);
                messages.add(chatMessage);
                sendingMessageCount.incrementAndGet();
                chatBoxEditText.getText().clear();

                // Update RecyclerView
                requireActivity().runOnUiThread(() -> {
                    chatContentAdapter.notifyDataSetChanged();
                    chatContentRecyclerView.scrollToPosition(messages.size() - 1);
                });

                if (hubConnection.getConnectionState() == HubConnectionState.CONNECTED) {
                    synchronized (chatMessage) {
                        hubConnection.send("BroadcastChatMessage",
                                deviceToken,
                                chatMessage.getSender(),
                                chatMessage.getTime(),
                                chatMessage.getContent(),
                                chatMessage.getUuid());
                    }
                }
            }
        }

        public void messageSendingHandler() {
            if (sendingMessageCount.get() > 0) {
                try {
                    Disposable toDispose = hubConnection.start().subscribe(
                            this::sendMessageQueue,
                            onError -> Log.e("HubConnection", onError.toString())
                    );
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }

        public void sendMessageQueue() {
            for (Message message : messages) {
                synchronized (message) {
                    if (message.getMessageEnum() == Message.SELF_SENDING_MESSAGE && hubConnection.getConnectionState() == HubConnectionState.CONNECTED) {
                        ChatMessage chatMessage = (ChatMessage) message;

                        hubConnection.send("BroadcastChatMessage",
                                deviceToken,
                                chatMessage.getSender(),
                                chatMessage.getTime(),
                                chatMessage.getContent(),
                                chatMessage.getUuid());
                    }
                }
            }
        }

        public void broadcastChatMessage(String senderDeviceToken, String sender, String time, String content, String uuid) {
            if (senderDeviceToken.equals(deviceToken)) { // A senderDeviceToken equals to current deviceToken serves as an ACK
                for (Message message : messages) {
                    synchronized (message) {
                        if (message.getUuid().equals(uuid) && message.getMessageEnum() == Message.SELF_SENDING_MESSAGE) {
                            // Change message status
                            message.setMessageEnum(Message.SELF_SENT_MESSAGE);
                            sendingMessageCount.decrementAndGet();
                            break;
                        }
                    }
                }
            } else { // Create ChatMessage according to parameters
                boolean isDuplicateMessage = false;
                for (Message message : messages) {
                    if (message.getUuid().equals(uuid)) {
                        isDuplicateMessage = true;
                        break;
                    }
                }
                if (!isDuplicateMessage) {
                    ChatMessage chatMessage = new ChatMessage(sender, time, content, uuid, Message.INCOMING_MESSAGE);
                    messages.add(chatMessage);
                }
            }
            requireActivity().runOnUiThread(() -> {
                chatContentAdapter.notifyDataSetChanged();
                chatContentRecyclerView.scrollToPosition(messages.size() - 1);
            });
        }

        public void broadcastEnterMessage(String username) {
            EnterLeaveMessage enterMessage = new EnterLeaveMessage(username, Message.ENTER_MESSAGE);
            messages.add(enterMessage);
            requireActivity().runOnUiThread(() -> {
                chatContentAdapter.notifyDataSetChanged();
                chatContentRecyclerView.scrollToPosition(messages.size() - 1);
            });
        }

        public void broadcastLeaveMessage(String username) {
            EnterLeaveMessage leaveMessage = new EnterLeaveMessage(username, Message.LEAVE_MESSAGE);
            messages.add(leaveMessage);
            requireActivity().runOnUiThread(() -> {
                chatContentAdapter.notifyDataSetChanged();
                chatContentRecyclerView.scrollToPosition(messages.size() - 1);
            });
        }

        static class ChatContentViewHolder extends RecyclerView.ViewHolder {
            // For ChatMessage
            private TextView messageSender;
            private TextView messageContent;
            private TextView messageTime;

            // For EnterLeaveMessage
            private TextView enterLeaveContent;

            ChatContentViewHolder(View view) {
                super(view);
                this.messageSender = (TextView) view.findViewById(R.id.textview_message_sender);
                this.messageContent = (TextView) view.findViewById(R.id.textview_message_content);
                this.messageTime = (TextView) view.findViewById(R.id.textview_message_time);
                this.enterLeaveContent = (TextView) view.findViewById(R.id.textview_enter_leave_content);
            }
        }

        static class ChatContentAdapter extends RecyclerView.Adapter<ChatContentViewHolder> {
            private Context context;
            private List<Message> messages;

            public ChatContentAdapter(List<Message> messages, Context context) {
                this.messages = messages;
                this.context = context;
            }

            @NonNull
            @Override
            public ChatContentViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
                View view;

                switch (viewType) {
                    case Message.SELF_SENDING_MESSAGE:
                        view = LayoutInflater.from(parent.getContext()).inflate(R.layout.item_sending_self_message, parent, false);
                        break;
                    case Message.SELF_SENT_MESSAGE:
                        view = LayoutInflater.from(parent.getContext()).inflate(R.layout.item_sent_self_message, parent, false);
                        break;
                    case Message.ENTER_MESSAGE:
                    case Message.LEAVE_MESSAGE:
                        view = LayoutInflater.from(parent.getContext()).inflate(R.layout.item_enter_leave_message, parent, false);
                        break;
                    case Message.INCOMING_MESSAGE:
                    default:
                        view = LayoutInflater.from(parent.getContext()).inflate(R.layout.item_incoming_message, parent, false);
                        break;
                }

                return new ChatContentViewHolder(view);
            }

            @Override
            public void onBindViewHolder(@NonNull ChatContentViewHolder viewHolder, int position) {
                Message message = messages.get(position);
                if (Message.ENTER_MESSAGE == message.getMessageEnum() || Message.LEAVE_MESSAGE == message.getMessageEnum()) {
                    EnterLeaveMessage enterLeaveMessage = (EnterLeaveMessage) message;
                    viewHolder.enterLeaveContent.setText(enterLeaveMessage.getContent());
                } else {
                    ChatMessage chatMessage = (ChatMessage) message;
                    viewHolder.messageSender.setText(chatMessage.getSender());
                    viewHolder.messageTime.setText(chatMessage.getTime());
                    viewHolder.messageContent.setText(chatMessage.getContent());
                }
            }

            @Override
            public int getItemCount() {
                return this.messages.size();
            }

            @Override
            public int getItemViewType(int position) {
                return messages.get(position).getMessageEnum();
            }
        }
    }
    ```
7. Edit `AndroidManifest.xml`

    1. Permit Internet connection
        
        Add 
        ```xml
        <uses-permission android:name="android.permission.INTERNET" />
        ```
        
        and
        ```xml
        <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
        ```
        
        under the `manifest` tag, parallel to `application` tag.
    2. Set `MainActivity` to singleton

        Add `android:launchMode="singleInstance"` to the attribute field of `activity` tag.
    3. Set notification layout

        Add
        ```xml
        <meta-data
            android:name="com.google.firebase.messaging.default_notification_icon"
            android:resource="@drawable/ic_launcher_foreground" />
        ```
        and
        ```xml
        <meta-data
            android:name="com.google.firebase.messaging.default_notification_color"
            android:resource="@color/colorAccent" />
        ```
        under `application` tag, parallel to `activity` tag.

7. Create Firebase project

    1. Goto [Firebase Console](https://console.firebase.google.com/)

    2. Add project -> Fill out project information -> Create project -> Wait for redirection

    3. Click the android icon -> Enter your app's package name, in our case is `com.microsoft.signalr.androidchatroom` -> Register

    4. Download the `google-services.json` and place it in `YOUR_APPLICATION/app/`


   
## Build a chat room app server with Azure SignalR Service and Visual Studio

1. Create the app server project

    1. Launch Visual Studio 2019 -> Create a new project -> Console App .Net Core (C#)
    
    2. Name your app server project -> Wait for completeion

2. Install dependency packages

    1. In Solution Explorer -> Right click on `YOUR_PROJECT_NAME` -> `Manage NuGet Packages...` -> Browse
    
    2. Search `Microsoft.Azure.SignalR` and install
    
    3. Search `FirebaseAdmin` and install

3. Create Firebase Messaging Client

    1. Create `FirebaseMessagingClient.cs` as follow:
    ```cs
    using FirebaseAdmin;
    using FirebaseAdmin.Messaging;
    using Google.Apis.Auth.OAuth2;
    using System.Threading.Tasks;
    using System;
    using System.Collections.Generic;

    public interface IFirebaseMessagingClient
    {
        Task SendNotification(string deviceToken, string title, string notificationBody);
    }

    public class FirebaseMessagingClient : IFirebaseMessagingClient
    {
        private readonly FirebaseMessaging messaging;

        public FirebaseMessagingClient()
        {
            var app = FirebaseApp.Create(new AppOptions() { Credential = GoogleCredential.FromFile("androidchatroomclient-firebase-adminsdk.json").CreateScoped("https://www.googleapis.com/auth/firebase.messaging") });
            messaging = FirebaseMessaging.GetMessaging(app);
        }

        private Message CreateNotification(string title, string notificationBody, string deviceToken)
        {
            return new Message()
            {
                Token = deviceToken,
                Android = new AndroidConfig()
                {
                    Priority = Priority.High,
                    Data = new Dictionary<string, string>()
                        {
                            { "k1", "v1" },
                            { "k2", "v2" },
                        },
                    Notification = new AndroidNotification()
                    {
                        Title = title,
                        Body = notificationBody,
                        ChannelId = "Message Notification Channel"
                    },
                    
                }
            };
        }

        public async Task SendNotification(string deviceToken, string title, string notificationBody)
        {
            Console.WriteLine(String.Format("Sending notification: title: {0}; content: {1}.", title, notificationBody));
            await messaging.SendAsync(CreateNotification(title, notificationBody, deviceToken));
        }
    }
    ```

4. Create `Hub` classes

    1. Create `ChatHub.cs` for chat requests as follow:
    ```cs
    using System;
    using System.Collections.Generic;
    using System.Text;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Connections.Features;
    using Microsoft.AspNetCore.SignalR;

    namespace Microsoft.Azure.SignalR.Samples.MobileChatRoom.Server
    {
        public class ChatHub : Hub
        {

            struct DeviceEntry
            {
                public readonly string connectionId;
                public string deviceToken;
                public readonly string username;

                public DeviceEntry(string connectionId, string deviceToken, string username)
                {
                    this.connectionId = connectionId;
                    this.deviceToken = deviceToken;
                    this.username = username;
                }
            }

            static Dictionary<string, DeviceEntry> DeviceTable = new Dictionary<string, DeviceEntry>();
            static IFirebaseMessagingClient MessagingClient = new FirebaseMessagingClient();

            public async Task BroadcastChatMessage(string deviceToken, string sender, string time, string content, string uuid)
            {
                Console.WriteLine(string.Format("Broadcasting: {0}", content));
                await Clients.All.SendAsync("broadcastChatMessage", deviceToken, sender, time, content, uuid);
                if (deviceToken.Equals(DeviceTable[Context.ConnectionId].deviceToken))
                {
                    foreach (var keyValuePair in DeviceTable)
                    {
                        string targetDeviceToken = keyValuePair.Value.deviceToken;
                        if (!targetDeviceToken.Equals(deviceToken))
                        {
                            await MessagingClient.SendNotification(targetDeviceToken, sender, content);
                        }
                    }
                }
            }

            public async Task EnterChatRoom(string deviceToken, string username)
            {
                Console.WriteLine(string.Format("Username: {0} has joined the chat room; DeviceToken: {1}.", username, deviceToken));
                DeviceTable[Context.ConnectionId] = new DeviceEntry(Context.ConnectionId, deviceToken, username);
                await Clients.All.SendAsync("broadcastEnterMessage", username);
            }

            public async Task LeaveChatRoom(string deviceToken, string username)
            {
                Console.WriteLine(string.Format("Username: {0} has left the chat room; DeviceToken: {1}.", username, deviceToken));
                await Clients.All.SendAsync("broadcastLeaveMessage", username);
            }

            public override async Task OnDisconnectedAsync(Exception exception)
            {
                string username = new string(DeviceTable[Context.ConnectionId].username);
                Console.WriteLine(string.Format("User: {0} has disconnected.", DeviceTable[Context.ConnectionId].username));
                DeviceTable.Remove(Context.ConnectionId);
                await Clients.All.SendAsync("broadcastLeaveMessage", username);
                await base.OnDisconnectedAsync(exception);
            }
        }
    }
    ```

5. Create startup configurations

    1. Create `Startup.cs` as follow:
    ```cs
    using Microsoft.AspNetCore.Builder;
    using Microsoft.AspNetCore.Hosting;
    using Microsoft.Extensions.DependencyInjection;
    using Microsoft.Extensions.Hosting;
    using System;
    using System.Collections.Generic;
    using System.Text;

    namespace Microsoft.Azure.SignalR.Samples.MobileChatRoom.Server
    {
        public class Startup
        {
            public void ConfigureServices(IServiceCollection services)
            {
                services.AddSignalR();
            }

            public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
            {
                if (env.IsDevelopment())
                {
                    app.UseDeveloperExceptionPage();
                }

                app.UseDefaultFiles();
                app.UseStaticFiles();
                app.UseRouting();
                app.UseEndpoints(endpoints =>
                {
                    endpoints.MapHub<ChatHub>("/chat");
                });
            }
        }
    }
    ```

6. Edit `Program.cs` as follow:
```cs
using Microsoft.AspNetCore;
using Microsoft.AspNetCore.Hosting;
using System;

namespace Microsoft.Azure.SignalR.Samples.MobileChatRoom.Server
{
    class Program
    {
        static void Main(string[] args)
        {
            CreateWebHostBuilder(args).Build().Run();
        }

        public static IWebHostBuilder CreateWebHostBuilder(string[] args) =>
            WebHost.CreateDefaultBuilder(args)
                .UseStartup<Startup>();
    }
}
```

8. Configure Firebase private key

    1. In [Firebase Console](https://console.firebase.google.com/) -> Click your project

    2. In `Settings` -> `Service Accounts` -> `Generate New Private Key` -> Download the private key -> Copy it as `YOUR_APP_SERVER_PROJECT/androidchatroomclient-firebase-adminsdk.json` (in root directory)

## Chat with the mobile app

1. Launch App Server

    1. Build and run your app server
    
        In your app server project directory
        ```cmd 
        dotnet build
        dotnet run
        ```

    2. Test your hub connection

        a. Open your browser and visit [HTTP Hub Port](http://localhost:5000/chat)

        b. You should see a `Connection ID required` response.

2. Launch Android Chat Room Clients

    1. Create two AVD in the Android Emulator

    2. Run the app on multiple clients

    3. Start chatting

        a. Login with any username

        b. Enter message and hit `SEND` button

        c. You should see the message on both client app

        d. Press `Home Button` on Device 1 and send a message on Device 2

        e. You should see a notification banner on the top of the screen

>TODO